name: Create Markdown from Form

on:
  workflow_dispatch:
    inputs:
      title:
        description: "Document title"
        required: true
      author:
        description: "Author name"
        required: true
      date:
        description: "Date (YYYY-MM-DD)"
        required: true
      body:
        description: "Main content"
        required: true
  workflow_call:
    inputs:
      title:
        description: Doc title
        required: true
        type: string
      author:
        required: true
        type: string
      date:
        required: true
        type: string
      body:
        required: true
        type: string

permissions:
  contents: write
  pull-requests: write

jobs:
  generate:
    runs-on: ubuntu-latest
    steps:
      - name: Normalize inputs
        id: norm
        run: |
          echo "title=${{ inputs.title || github.event.inputs.title }}" >> "$GITHUB_OUTPUT"
          echo "author=${{ inputs.author || github.event.inputs.author }}" >> "$GITHUB_OUTPUT"
          echo "date=${{ inputs.date || github.event.inputs.date }}"       >> "$GITHUB_OUTPUT"
          # Multiline-safe output for BODY:
          {
            echo 'body<<EOF'
            echo '${{ inputs.body || github.event.inputs.body }}'
            echo 'EOF'
          } >> "$GITHUB_OUTPUT"
      - uses: actions/checkout@v4

      - name: Make filename-safe slug
        id: slug
        run: |
          t="${{ steps.norm.outputs.title }}"
          # slugify: lowercase, replace spaces/non-alnum with hyphens, squeeze hyphens
          s="$(echo "$t" | tr '[:upper:]' '[:lower:]' | sed -E 's/[^a-z0-9]+/-/g; s/^-+|-+$//g')"
          echo "value=$s" >> "$GITHUB_OUTPUT"
          
      - name: Render template
        run: |
          out="test_dir/${{ steps.slug.outputs.value }}.md"
          mkdir -p "$(dirname "$out")"

          export TITLE='${{ steps.fields.outputs.title }}'
          export AUTHOR='${{ steps.fields.outputs.author }}'
          export DATE='${{ steps.fields.outputs.date }}'
          export BODY='${{ steps.fields.outputs.content }}'   # can be multiline

          envsubst < templates/post.md.tpl > "$out"

      - name: Commit & push change
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "41898282+github-actions[bot]@users.noreply.github.com"
          git checkout -b chore/${{ steps.slug.outputs.value }}
          git add -A
          git commit -m "New Test: ${{ steps.norm.outputs.title }}"
          git push -u origin chore/${{ steps.slug.outputs.value }}
      - name: Create PR
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          gh pr create \
            --base master \
            --head chore/${{ steps.slug.outputs.value }} \
            --title "New Test: ${{ steps.norm.outputs.title }}" \
            --body "Adding new test: ${{ steps.norm.outputs.title }}"
